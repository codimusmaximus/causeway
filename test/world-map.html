<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive World Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        header {
            background: #16213e;
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        header h1 { font-size: 1.5rem; color: #e94560; }
        .container { display: flex; height: calc(100vh - 60px); }
        #map { flex: 1; height: 100%; }
        #details {
            width: 350px;
            background: #16213e;
            padding: 2rem;
            overflow-y: auto;
            border-left: 3px solid #e94560;
        }
        #details h2 { color: #e94560; margin-bottom: 1rem; font-size: 1.8rem; }
        #details .placeholder { color: #888; font-style: italic; }
        .info-item {
            margin: 1rem 0;
            padding: 0.8rem;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .info-item label {
            display: block;
            font-size: 0.75rem;
            color: #e94560;
            text-transform: uppercase;
            margin-bottom: 0.3rem;
        }
        .info-item span { font-size: 1.1rem; }
        .flag { font-size: 4rem; text-align: center; margin-bottom: 1rem; }
        .leaflet-container { background: #1a1a2e; }
    </style>
</head>
<body>
    <header>
        <h1>Interactive World Map</h1>
    </header>
    <div class="container">
        <div id="map"></div>
        <div id="details">
            <p class="placeholder">Click on a country to see its details</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Cache for country data from API
        let countryCache = {};

        // Load all countries into cache on startup
        fetch('/api/countries')
            .then(r => r.json())
            .then(countries => {
                countries.forEach(c => countryCache[c.code] = c);
                console.log('Loaded', Object.keys(countryCache).length, 'countries');
            });

        // Initialize map
        const map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 8,
            worldCopyJump: true
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OSM &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Load GeoJSON
        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
            .then(response => response.json())
            .then(data => {
                const geojsonLayer = L.geoJSON(data, {
                    style: () => ({
                        fillColor: '#2d4059',
                        weight: 1,
                        opacity: 1,
                        color: '#e94560',
                        fillOpacity: 0.6
                    }),
                    onEachFeature: (feature, layer) => {
                        layer.on({
                            mouseover: e => {
                                e.target.setStyle({ fillColor: '#e94560', fillOpacity: 0.8 });
                            },
                            mouseout: e => {
                                geojsonLayer.resetStyle(e.target);
                            },
                            click: e => {
                                const code = feature.properties['ISO3166-1-Alpha-3'];
                                const name = feature.properties.name;
                                showDetails(code, name);
                                map.fitBounds(e.target.getBounds(), { padding: [50, 50] });
                            }
                        });
                    }
                }).addTo(map);
            });

        async function showDetails(code, fallbackName) {
            const details = document.getElementById('details');

            // Skip invalid codes from GeoJSON
            if (!code || code === '-99') {
                details.innerHTML = `
                    <h2>${fallbackName || 'Unknown'}</h2>
                    <p class="placeholder">No data available for this territory.</p>
                `;
                return;
            }

            // Try cache first, then API
            let data = countryCache[code];
            if (!data) {
                try {
                    const res = await fetch('/api/countries/' + code);
                    if (res.ok) {
                        data = await res.json();
                        countryCache[code] = data;
                    }
                } catch (e) {
                    console.error('Failed to fetch', code, e);
                }
            }

            if (data) {
                details.innerHTML = `
                    <div class="flag">${data.flag || ''}</div>
                    <h2>${data.name}</h2>
                    <div class="info-item">
                        <label>Capital</label>
                        <span>${data.capital || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <label>Population</label>
                        <span>${data.population || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <label>Region</label>
                        <span>${data.region || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <label>Currency</label>
                        <span>${data.currency || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <label>Language</label>
                        <span>${data.language || 'N/A'}</span>
                    </div>
                `;
            } else {
                details.innerHTML = `
                    <h2>${fallbackName || code}</h2>
                    <p class="placeholder">No data available (code: ${code})</p>
                `;
            }
        }
    </script>
</body>
</html>
